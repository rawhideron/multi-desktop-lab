name: Build Linux Desktop Environments

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      distro:
        description: 'Distribution to build (ubuntu, debian, fedora, arch, mint, kali, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ubuntu
          - debian
          - fedora
          - arch
          - mint
          - kali

jobs:
  # Determine which distributions to build
  determine-distros:
    runs-on: ubuntu-latest
    outputs:
      distros: ${{ steps.set-distros.outputs.distros }}
    steps:
      - name: Set distributions to build
        id: set-distros
        run: |
          if [ "${{ github.event.inputs.distro }}" == "all" ] || [ -z "${{ github.event.inputs.distro }}" ]; then
            echo 'distros=["ubuntu","debian","fedora","arch","mint","kali"]' >> $GITHUB_OUTPUT
          else
            echo "distros=[\"${{ github.event.inputs.distro }}\"]" >> $GITHUB_OUTPUT
          fi

  # Build each distribution on a separate runner (parallel, saves disk space)
  build:
    needs: determine-distros
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro: ${{ fromJson(needs.determine-distros.outputs.distros) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Free up disk space
      run: |
        echo "Disk space before cleanup:"
        df -h
        echo "Docker disk usage:"
        docker system df || true
        # Remove unused Docker resources
        docker system prune -af --volumes || true
        # Remove build cache
        docker builder prune -af || true
        echo "Disk space after cleanup:"
        df -h

    - name: Build container
      env:
        DESKTOP_USER: ${{ secrets.DESKTOP_USER || 'user' }}
        DESKTOP_PASSWORD: ${{ secrets.DESKTOP_PASSWORD || 'password' }}
      run: |
        export DESKTOP_USER=${DESKTOP_USER:-user}
        export DESKTOP_PASSWORD=${DESKTOP_PASSWORD:-password}
        
        echo "=== Building ${{ matrix.distro }} ==="
        echo "Disk space before build:"
        df -h
        
        # Stop and remove existing container if it exists
        docker compose stop ${{ matrix.distro }} || true
        docker compose rm -f ${{ matrix.distro }} || true
        
        # Remove old image to force rebuild
        docker rmi multi-desktop-lab-${{ matrix.distro }}:latest || true
        
        # Build the container
        docker compose build --no-cache ${{ matrix.distro }}
        
        echo "Disk space after build:"
        df -h
        
        # Test that the container can start
        docker compose up -d ${{ matrix.distro }}
        sleep 10
        
        # Check if container is running
        if docker compose ps ${{ matrix.distro }} | grep -q "Up"; then
          echo "${{ matrix.distro }} container started successfully"
        else
          echo "ERROR: ${{ matrix.distro }} container failed to start"
          docker compose logs ${{ matrix.distro }}
          exit 1
        fi
        
        # Stop and remove the test container
        docker compose stop ${{ matrix.distro }}
        docker compose rm -f ${{ matrix.distro }}

    - name: Final Cleanup
      if: always()
      run: |
        echo "Final disk space check:"
        df -h
        docker compose down || true
        docker system prune -af --volumes || true
        docker builder prune -af || true
        echo "Final disk space:"
        df -h

